<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reservar turno</title>
  <link rel="stylesheet" href="/default.css">
  <!-- CLIENTE_STYLE -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <main>
    <!-- CLIENTE_LOGO -->
    <!-- CLIENTE_NOMBRE -->

    <form id="form-turno">
      <h1>Reservar turno</h1>
      <input type="text" name="nombre" placeholder="Tu nombre" required>
      <input type="email" name="correo" placeholder="Tu correo" required>
      <input type="tel" name="whatsapp" placeholder="WhatsApp (+549...)" required>
       <input type="date" name="fecha" id="fecha" required min="">

      <select name="servicio" id="servicio-select" required>
        <option value="">-- Seleccionar servicio --</option>
      </select>

     
      <select name="hora" id="hora-select" required>
        <option value="">-- Seleccionar hora --</option>
      </select>

      <button type="submit">Reservar</button>
      <div id="mensaje"></div>
    </form>
  </main>

  <script>
    const clienteId = window.location.pathname.split('/')[1];
const form = document.getElementById('form-turno');
const horaSelect = document.getElementById('hora-select');
const mensaje = document.getElementById('mensaje');
const btnReservar = form.querySelector('button[type="submit"]');
const servicioSelect = document.getElementById('servicio-select');

let config = null;

async function cargarConfig() {
  try {
    const res = await fetch(`/api/config/${clienteId}`);
    if (!res.ok) throw new Error('No se encontró config');
    config = await res.json();

    Object.keys(config.servicios || {}).forEach(nombre => {
      const opt = document.createElement('option');
      opt.value = nombre;
      opt.textContent = nombre;
      servicioSelect.appendChild(opt);
    });

    servicioSelect.addEventListener('change', () => {
      cargarHorarios();
    });

  } catch (err) {
    console.error(err);
    mensaje.textContent = 'Error cargando configuración';
  }
}

async function cargarHorarios() {
  const fecha = form.fecha.value;
  const servicio = servicioSelect.value;

  if (!fecha || !servicio || !config) {
    mensaje.textContent = 'Completa servicio y fecha válidos';
    return;
  }
  if (!config.dias || !Array.isArray(config.dias)) {
  mensaje.textContent = 'Configuración incorrecta de días';
  btnReservar.disabled = true;
  return;
}


  try {
    const res = await fetch(`/turnos/${clienteId}.json`);
    const turnos = res.ok ? await res.json() : [];

    horaSelect.innerHTML = '<option value="">-- Seleccionar hora --</option>';

    const fechaSeleccionada = new Date(fecha);
const diaSemana = fechaSeleccionada.getDay(); // 0 = domingo, 1 = lunes...

const horarioDia = config.horarios && config.horarios[diaSemana];

if (!horarioDia) {
  mensaje.textContent = 'Ese día no se trabaja';
  btnReservar.disabled = true;
  return;
}

const inicio = horarioDia.inicio * 60;
const fin = horarioDia.fin * 60;

    const ocupados = turnos
      .filter(t => t.fecha === fecha)
      .map(t => {
        const [h, m] = t.hora.split(':').map(Number);
        const mins = h * 60 + m;
        const dur = config.servicios?.[t.servicio] || config.duracionTurno || 30;
        return { inicio: mins, fin: mins + dur };
      })
      .sort((a, b) => a.inicio - b.inicio);

    const duracionMin = config.servicios[servicio];
    if (!duracionMin) {
      mensaje.textContent = 'Duración del servicio no válida';
      return;
    }

    let min = inicio;
    let disponibles = 0;

    while (min + duracionMin <= fin) {
      const haySolape = ocupados.some(t => Math.max(min, t.inicio) < Math.min(min + duracionMin, t.fin));

      if (!haySolape) {
        const h = String(Math.floor(min / 60)).padStart(2, '0');
        const m = String(min % 60).padStart(2, '0');
        const hora = `${h}:${m}`;

        const opt = document.createElement('option');
        opt.value = hora;
        opt.textContent = hora;
        horaSelect.appendChild(opt);
        disponibles++;

        min += duracionMin;
      } else {
        const siguienteOcupado = ocupados.find(t => t.inicio >= min);
        min = siguienteOcupado ? siguienteOcupado.fin : min + duracionMin;
      }
    }

    if (disponibles === 0) {
      const opt = document.createElement('option');
      opt.textContent = 'No hay horarios disponibles';
      opt.disabled = true;
      opt.selected = true;
      horaSelect.appendChild(opt);
    }

    btnReservar.disabled = disponibles === 0;

  } catch (error) {
    console.error('Error cargando horarios:', error);
    mensaje.textContent = 'No se pudieron cargar los horarios';
  }
}


form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const datos = {
    nombre: form.nombre.value,
    correo: form.correo.value,
    whatsapp: form.whatsapp.value,
    fecha: form.fecha.value,
    hora: form.hora.value,
    servicio: form.servicio.value
  };

  const res = await fetch(`/api/agendar/${clienteId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(datos)
  });

  const data = await res.json();
  mensaje.textContent = data.mensaje || 'Error al agendar turno';
  if (res.ok) {
    form.reset();
    horaSelect.innerHTML = '<option value="">-- Seleccionar hora --</option>';
    btnReservar.disabled = false;
  }
  await cargarHorarios();
});

document.addEventListener('DOMContentLoaded', async () => {
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('fecha').setAttribute('min', hoy);
  await cargarConfig();
});

  </script>
</body>
</html>

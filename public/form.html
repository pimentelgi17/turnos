<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reservar turno</title>
  <link rel="stylesheet" href="/default.css">
  <!-- CLIENTE_STYLE -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <main>
    <!-- CLIENTE_LOGO -->
    <!-- CLIENTE_NOMBRE -->

    <form id="form-turno">
      <h1>Reservar turno</h1>
      <input type="text" name="nombre" placeholder="Tu nombre" required>
      <input type="email" name="correo" placeholder="Tu correo" required>
      <input type="tel" name="whatsapp" placeholder="WhatsApp (+549...)" required>
      <input type="date" name="fecha" id="fecha" required min="">
      <select name="hora" id="hora-select" required>
        <option value="">-- Seleccionar hora --</option>
      </select>
      <button type="submit">Reservar</button>
      <div id="mensaje"></div>
    </form>
  </main>

  <script>
const clienteId = window.location.pathname.split('/')[1];
const form = document.getElementById('form-turno');
const horaSelect = document.getElementById('hora-select');
const mensaje = document.getElementById('mensaje');
const btnReservar = form.querySelector('button[type="submit"]');

let config = null;
let intervaloMin = 30;

async function cargarConfig() {
  try {
    const res = await fetch(`/api/config/${clienteId}`);
    if (!res.ok) throw new Error('Config no encontrado');
    config = await res.json();

    if (config.duracionTurno) intervaloMin = parseInt(config.duracionTurno);
  } catch (error) {
    console.error('Error cargando configuración:', error);
    mensaje.textContent = 'Error cargando configuración';
  }
}

async function cargarHorarios() {
  const fecha = form.fecha.value;
  if (!fecha || !config) return;

  const diaSemana = new Date(fecha).getDay();
  if (!config.dias.includes(diaSemana)) {
    mensaje.textContent = 'No se atiende este día';
    horaSelect.innerHTML = '<option value="">-- Seleccionar hora --</option>';
    btnReservar.disabled = true;
    return;
  }

  try {
    const res = await fetch(`/turnos/${clienteId}.json`);
    const turnos = res.ok ? await res.json() : [];
    const ocupados = turnos.filter(t => t.fecha === fecha).map(t => t.hora);

    horaSelect.innerHTML = '<option value="">-- Seleccionar hora --</option>';

    const inicio = (config.horaInicio ?? 9) * 60;
    const fin = (config.horaFin ?? 18) * 60;

    let disponibles = 0;

    for (let min = inicio; min + intervaloMin <= fin; min += intervaloMin) {
      const h = String(Math.floor(min / 60)).padStart(2, '0');
      const m = String(min % 60).padStart(2, '0');
      const hora = `${h}:${m}`;
      if (ocupados.includes(hora)) continue;

      const option = document.createElement('option');
      option.value = hora;
      option.textContent = hora;
      horaSelect.appendChild(option);
      disponibles++;
    }

    if (disponibles === 0) {
      const opt = document.createElement('option');
      opt.textContent = 'No hay horarios disponibles';
      opt.disabled = true;
      opt.selected = true;
      horaSelect.appendChild(opt);
    }

    btnReservar.disabled = disponibles === 0;
  } catch (error) {
    console.error('Error cargando horarios:', error);
    mensaje.textContent = 'No se pudieron cargar los horarios';
  }
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const datos = {
    nombre: form.nombre.value,
    correo: form.correo.value,
    whatsapp: form.whatsapp.value,
    fecha: form.fecha.value,
    hora: form.hora.value
  };

  const res = await fetch(`/api/agendar/${clienteId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(datos)
  });

  const data = await res.json();
  mensaje.textContent = data.mensaje || 'Error al agendar turno';
  if (res.ok) {
    form.reset();
    horaSelect.innerHTML = '<option value="">-- Seleccionar hora --</option>';
    btnReservar.disabled = false;
  }
  await cargarHorarios();
});

document.addEventListener('DOMContentLoaded', async () => {
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('fecha').setAttribute('min', hoy);
  await cargarConfig();
  document.getElementById('fecha').addEventListener('change', cargarHorarios);
});
</script>


</body>
</html>
